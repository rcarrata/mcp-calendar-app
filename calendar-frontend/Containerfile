# Use Node.js 18 LTS for building
FROM node:18-alpine AS builder

# Set working directory
WORKDIR /app

# Copy package files
COPY package*.json ./

# Copy source code
COPY src/ ./src/
COPY public/ ./public/

# Install dependencies and build
RUN npm install && npm run build

# Use nginx to serve the static files
FROM nginx:alpine

# Copy built app from builder stage
COPY --from=builder /app/build /usr/share/nginx/html

# Copy complete nginx configuration
COPY src/nginx.conf /etc/nginx/nginx.conf

# Create non-root user and set permissions
RUN addgroup -g 1001 nginx-user && \
    adduser -u 1001 -G nginx-user -s /bin/sh -D nginx-user && \
    chown -R nginx-user:nginx-user /usr/share/nginx/html && \
    mkdir -p /tmp/nginx_client_temp /tmp/nginx_proxy_temp /tmp/nginx_fastcgi_temp /tmp/nginx_uwsgi_temp /tmp/nginx_scgi_temp && \
    chown -R nginx-user:nginx-user /tmp/nginx_*

USER nginx-user

# Expose port
EXPOSE 8080

# Start nginx
CMD ["nginx", "-g", "daemon off;"]